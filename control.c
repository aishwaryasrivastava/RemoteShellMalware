/*
    Control Program for sending and receing command from Execution module.
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>      // strlen
#include <sys/socket.h>  // socket
#include <arpa/inet.h>   // inet_addr
#include <unistd.h>      // write

int main(int argc , char *argv[])
{
    // Variables
    int ssock, csock, addrlen, ret;
    struct sockaddr_in controler, executor;
    char message[5000], reply[5000];

    short port = 8888;

    // Create a socket. 
    ssock = socket(AF_INET, SOCK_STREAM, 0);
    if (ssock == -1) {
        perror("Error creating socket\n");
        exit(0);
    }
    printf("Server socket created\n");

    // all the ip addresses of the server can be used to set up connection.
    // Set the server ip address, connection family and port. INADDR_ANY means
    controler.sin_family      = AF_INET;
    controler.sin_addr.s_addr = INADDR_ANY;
    controler.sin_port        = htons(port);

    if (bind(ssock, (struct sockaddr *) &controler, sizeof(controler)) < 0) {
        perror("Error binding\n");
        close(ssock);
        exit(0);
    }
    printf("Binding done\n");

    // Listen for incoming connections
    listen(ssock, SOMAXCONN);
    printf("Listening...\n");

    printf("Waiting for incoming connections...\n");
    addrlen = sizeof(struct sockaddr_in);

    // Accept connection from an incoming executor
    csock = accept(ssock, (struct sockaddr *) &executor, (socklen_t *) &addrlen);
    if (csock < 0) {
        perror("Error accepting connections\n");
        exit(0);
    }
    printf("Connection accepted\n");
    size_t len,result;
    char *cmd = NULL;
    
    while(1) {
       printf("Enter Command $ ");
       result = getline(&cmd, &len, stdin);
		
       if(result == -1) {
	  printf("getline error\n");
	  continue;
       }
        cmd[result-1] = 0; 
        if (strcmp(cmd, "end") == 0) {
            break;
        }
        // Send the message to executor
        if ((ret = write(csock, cmd, strlen(cmd))) <= 0) {
            perror("Error writing\n");
            break;
        }

        memset(reply, 0, sizeof(reply));
        // Receive a reply from the executor.
        if ((ret = recv(csock, reply, sizeof(reply), 0)) <= 0) {
            perror("Error receiving\n");
            break;
        }
         if (strcmp(reply, "error") == 0) {
	    printf(" Error Executing Command !!\n\n ");	 
        } else 
           printf("\n ******Response ****** \n\n %s \n *********************\n\n", reply);
    }

    close(csock);
    close(ssock);
    printf("End connection\n");

    return 0;
}
